<?php// The expires time (2 months):$expiresTime=time() + 5184000;// Expires header:header('Expires: '.gmdate('D, d M Y H:i:s \G\M\T', $expiresTime));// This response is ordinary HTML:header('Content-Type: text/html');?><!doctype html><html><head><style type='text/css'>@font-face{    font-family:"SourceSansProLight";    src:url("/Font/SourceSansProLight.woff") format('woff');}body{	background:#0194E1;	font-family:"SourceSansProLight","lucida grande",tahoma,verdana;	color:#ffffff;	font-size:1.4em;	margin:0;	border:0;	padding:0;}.btn{	display:inline-block;	padding:10px;	border:1px solid #ffffff;	border-radius:4px;	background:#1776a8;}.btn:hover{	cursor:pointer;}.inputBox{	padding:10px;	font-family: "SourceSansProLight","lucida grande",tahoma,verdana;	border: 1px solid #ffffff;    border-radius: 4px;	width: 300px;	color: #000000;}a:link,a:visited{	color:#ffffff;	text-decoration:none;}</style><!--[If IE]><style>@font-face{    font-family:"SourceSansProLight";    src:url("/Font/SourceSansProLight.eot");}</style><![endif]--></head><body><div id='keypad' style='display:none;'><center>	<style type='text/css'>.keypad_button:hover,.keypad_number:hover{	cursor:pointer;}.noselect{  -webkit-touch-callout:none;  -webkit-user-select:none;  -khtml-user-select:none;   -moz-user-select:none;   -ms-user-select:none;  user-select:none;}.keypad_button,.keypad_number{	width:100px;	height:100px;	background:#1776a8;	color:#ffffff;	text-align:center;	vertical-align:middle;	border:1px solid #ffffff;	font-weight:bold;	font-size:1.4em;}.keypad_number:active{	background:#53baf0;}#keypad_screen{	width:100%;	height:100px;	color:#000000;	background:#ffffff;	text-align:center;	font-size:3em;	border:1px solid #ffffff;}</style>		<table style='width:500px;' cellpadding=0 cellspacing=5>				<tr style='width:100%;'>			<td id='keypad_screen' colspan=3>						</td>		</tr>		<tr style='width:100%;'>			<td class='keypad_number noselect' onmousedown='Keypad.add(1)'>1</td>			<td class='keypad_number noselect' onmousedown='Keypad.add(2)'>2</td>			<td class='keypad_number noselect' onmousedown='Keypad.add(3)'>3</td>		</tr>		<tr style='width:100%;'>			<td class='keypad_number noselect' onmousedown='Keypad.add(4)'>4</td>			<td class='keypad_number noselect' onmousedown='Keypad.add(5)'>5</td>			<td class='keypad_number noselect' onmousedown='Keypad.add(6)'>6</td>		</tr>		<tr style='width:100%;'>			<td class='keypad_number noselect' onmousedown='Keypad.add(7)'>7</td>			<td class='keypad_number noselect' onmousedown='Keypad.add(8)'>8</td>			<td class='keypad_number noselect' onmousedown='Keypad.add(9)'>9</td>		</tr>		<tr style='width:100%;'>			<td class='keypad_button' style='background:#A81740 url(/Images/Keypad-Cancel.svg) no-repeat center;' onmousedown='Keypad.clear()'></td>			<td class='keypad_number noselect' onmousedown='Keypad.add(0)'>0</td>			<td class='keypad_button' style='background:#81fd74 url(/Images/Keypad-Ok.svg) no-repeat center;' onmousedown='Keypad.accept()'></td>		</tr>	</table>		<div id='pin_status'></div></center></div><div id='paydata' style='display:none'></div><script type='text/javascript' src='/js/util.js'></script><script type='text/javascript'>var API={Version:1,Loading:'Loading - Just a moment..'};var Keypad={		max:4,	currentInput:'',	onAccept:null,		clear:function(){		this.currentInput='';		this.updateScreen();	},		updateScreen:function(){				var val='';				for(var i=0;i<this.currentInput.length;i++){			val+='*';		}				document.getElementById('keypad_screen').innerHTML=val;	},		goBack:function(){		var c=this.currentInput;		if(c){			this.currentInput=c.substring(0,c.length-1);		}		this.updateScreen();	},		display:function(visible,onAccept){				this.clear();		this.onAccept=onAccept;				var box=document.getElementById('keypad').style;				if(visible){			box.display='';		}else{			box.display='none';		}			},		add:function(n){				if(this.currentInput.length==this.max){			return;		}				this.currentInput+=n.toString();		this.updateScreen();			},		accept:function(){		this.onAccept(this.currentInput);		this.display(false,null);	}	};function onPinEntered(pin){		// Load the private key (this can't tell if the pin is right or not):	loadKeyEncrypted(function(){				// In order to save some time (~0.5s; delay depends entirely on merchant services), 		// we asked the bank to grab the checkout information whilst the user entered their pin.		// However, that meant the bank didn't know what account we're using, so we'll now update it.		request('/v1/checkout/connect',function(d,req){						if(req.status==200){								// Everything checked out as valid!				pinStatus('');				paydata.style.display='';							}else{								// Bad pin! Possibly a bad sequence too (depends on the other errors).				if(d.type=='error/device/locked'){					// Too many failed attempts; device is locked										pinStatus('<h1>This device is temporarily locked</h1><br>You\'ve used 3 wrong pins - you\'ll need to wait 15 minutes before you can try again.');									}else{										// Assumes error/signature/invalid here.					pinStatus('That pin wasn\'t right - Try again');										// Prompt for pin:					Keypad.display(true,onPinEntered);									}			}					},{id:checkoutInfo.id});			},pin,true);	}function pinStatus(msg){		document.getElementById("pin_status").innerHTML=msg+"<br>";	}// Load the hash vars:var hash=window.location.hash.substring(1);var urlVariables=loadQueryString(hash);// Get the code:var code=urlVariables['code'];var checkoutInfo=null;setupDevice();function beginCheckout(){		// Get the gateway:	var gateway=urlVariables['gateway'];		if(!code || !gateway){		paydata.style.display='';		paydata.innerHTML='The merchant service made a bad request. Code and gateway is required.';		return;	}		if(!Account){		paydata.style.display='';		paydata.innerHTML='Hello! We\'ve not seen this device before. You\'ll need to connect this device to your OpenBank acocunt before you can use it.';		return;	}		Keypad.display(true,onPinEntered);	// Tidy it up:	code=code.trim().toUpperCase();		// The username must be stored with the device ID 	// when the account is created/ the device is linked.	// That's also part of the "create account deletes private key" solution.	var fromUser=Account.username;		// Ok! Load the hash now.	Ajax.request('/v1/checkout/start',function(r){		checkoutInfo=JSON.parse(r);				redraw();			},{code:code,gateway:gateway,username:fromUser});	}var paydata=document.getElementById('paydata');beginCheckout();function payNow(b){		b.style.display='none';	var status=document.getElementById('pay_status');	status.innerHTML=API.Loading;		request('/v1/checkout/pay',function(r,req){				if(req.status==200){						paydata.innerHTML='<center><h1>Transaction successful!</h1><br><br>You don\'t need to do anything else.</center>';			return;					}				if(r.type=='error/account/nofunds'){						// Account doesn't have enough.			status.innerHTML='Your account doesn\'t have enough funds to complete this request.';					}else{			status.innerHTML='There was an error with your request - the full information is:<br><br>'+JSON.stringify(r);		}				b.style.display='';			},{id:checkoutInfo.id});	}function redraw(){		var ci=checkoutInfo;	var div=ci.commodity.divisor;		var dp=(div.toString().length-1);		// Let's take the amount and divide by the divisor to give something displayable.	var rawAmount=(parseInt(ci.total)/parseInt(div));		var m=ci.merchant.name;		if(!ci.title){		ci.title=m+' Order';	}		var html='<center><h1>'+ci.title+'</h1><br><div style="font-size:1.6em;">'+m+'</div>';	html+='<br><br><br><h1>'+rawAmount.toFixed(dp)+' '+ci.commodity.name+'</h1><br><br><br>';	html+='<div class="btn" style="font-size:2em;" onmousedown="payNow(this)">Pay Now</div><div id="pay_status"></div></center>';		paydata.innerHTML=html;}</script></body></html>